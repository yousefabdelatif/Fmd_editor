<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>A Comprehensive Fitx Document</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
  <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      font-size: 17px;
      max-width: 900px;
      margin: 0 auto;
      padding: 2.5cm;
      background-color: #f5f5f5;
    }
    .page {
      background: white;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      width: 21cm;
      min-height: 29.7cm;
      padding: 2.5cm;
      box-sizing: border-box;
      margin: 1cm auto;
      border: 1px solid #e0e0e0;
    }
    @media print {
      body { background: none; padding: 0; }
      .page {
        box-shadow: none;
        border: none;
        margin: 0;
        width: 21cm;
        min-height: 29.7cm;
        padding: 2.5cm;
        page-break-after: always;
      }
      .page:last-child { page-break-after: avoid; }
      .no-print { display: none; }
      canvas, pre, .katex-display { page-break-inside: avoid; }
      canvas { max-width: 100% !important; height: auto !important; }
      h1, h2 { color: #005a9c; }
      a { color: #007acc; }
      pre {
        background: #f4f4f4;
        padding: 1rem;
        border-radius: 0.5rem;
        overflow-x: auto;
      }
      .katex { font-size: 1.2em; }
      canvas { max-width: 100%; height: 300px; }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1rem;
      }
      th, td {
        border: 1px solid #ccc;
        padding: 0.5rem;
        text-align: left;
      }
      th { background-color: #f4f4f4; }
    }
  </style>
</head>
<body>
  <button onclick="window.print()" class="no-print bg-blue-500 text-white px-4 py-2 rounded mb-4">Print Document</button>
  <div id="document-container"></div>

  <script>
    let docData = {%%placeholer%%};

    function renderMarkdown(text) {
      return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                 .replace(/\*(.*?)\*/g, '<em>$1</em>')
                 .replace(/\[(red)\](.*?)\[\/\1\]/g, '<span style="color:red;">$2</span>');
    }

    function createPageElement() {
      const page = document.createElement('div');
      page.className = 'page';
      return page;
    }

    function renderContentItem(item, container) {
      let element;
      if (item.type === 'text') {
        const p = document.createElement('p');
        p.innerHTML = renderMarkdown(item.content);
        element = p;
      } else if (item.type === 'list') {
        const list = document.createElement(item.list_type === 'ordered' ? 'ol' : 'ul');
        list.className = 'list-disc ml-6';
        item.items.forEach(i => {
          const li = document.createElement('li');
          li.innerHTML = renderMarkdown(i);
          list.appendChild(li);
        });
        element = list;
      } else if (item.type === 'code') {
        const pre = document.createElement('pre');
        const code = document.createElement('code');
        code.textContent = item.content;
        pre.appendChild(code);
        element = pre;
      } else if (item.type === 'equation') {
        const div = document.createElement('div');
        katex.render(item.content, div, { throwOnError: false });
        element = div;
      } else if (item.type === 'graph') {
        const canvasContainer = document.createElement('div');
        const canvas = document.createElement('canvas');
        canvas.style.height = '300px';
        canvasContainer.appendChild(canvas);
        element = canvasContainer;
      } else if (item.type === 'table') {
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const tbody = document.createElement('tbody');
        const headerRow = document.createElement('tr');
        item.headers.forEach(h => {
          const th = document.createElement('th');
          th.textContent = h;
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);
        item.rows.forEach(row => {
          const tr = document.createElement('tr');
          row.forEach(cell => {
            const td = document.createElement('td');
            td.textContent = cell;
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        element = table;
      } else if (item.type === 'image') {
        const img = document.createElement('img');
        img.src = item.src;
        img.alt = item.alt;
        img.style.maxWidth = '100%';
        img.style.height = 'auto';
        element = img;
      }

      if (element) {
        element.classList.add('mb-4');
        container.appendChild(element);

        if (item.type === 'graph') {
          const ctx = element.querySelector('canvas').getContext('2d');
          new Chart(ctx, {
            type: item.graph_type,
            data: {
              labels: item.data.labels,
              datasets: [{
                label: item.caption,
                data: item.data.data,
                backgroundColor: item.graph_type === 'bar'
                  ? '#36a2eb'
                  : ['#ff6384', '#36a2eb', '#ffce56'],
                borderColor: '#005a9c',
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: item.graph_type === 'pie' },
                title: { display: true, text: item.caption }
              },
              scales: item.graph_type === 'bar'
                ? { y: { beginAtZero: true } }
                : {}
            }
          });
        }
      }
    }

    function renderDocument() {
      const container = document.getElementById('document-container');
      container.innerHTML = '';
      const page = createPageElement();

      const titleSection = document.createElement('div');
      titleSection.className = 'title-section mb-8';
      const title = document.createElement('h1');
      title.textContent = docData.title;
      title.className = 'text-3xl font-bold mb-4 text-center';
      titleSection.appendChild(title);
      const author = document.createElement('p');
      author.textContent = `By ${docData.author}`;
      author.className = 'text-lg italic mb-8 text-center';
      titleSection.appendChild(author);
      page.appendChild(titleSection);

      docData.sections.forEach(section => {
        const sectionContainer = document.createElement('div');
        sectionContainer.className = 'section';
        const heading = document.createElement('h2');
        heading.textContent = section.heading;
        heading.className = 'text-2xl font-semibold mb-4';
        sectionContainer.appendChild(heading);
        section.content.forEach(item => renderContentItem(item, sectionContainer));
        page.appendChild(sectionContainer);
      });

      // âœ… append built page
      container.appendChild(page);
    }

    document.addEventListener('DOMContentLoaded', renderDocument);
  </script>
</body>
</html>
